FROM node:24-slim

WORKDIR /app

# Configurar zona horaria (se cachea)
ENV TZ=America/Lima
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Instalar dependencias del sistema (se cachea)
RUN apt-get update && apt-get install -y \
    git \
    wget \
    apt-transport-https \
    software-properties-common \
    cron \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# Instalar PowerShell 7 (se cachea)
RUN wget -q https://packages.microsoft.com/config/debian/12/packages-microsoft-prod.deb \
    && dpkg -i packages-microsoft-prod.deb \
    && rm packages-microsoft-prod.deb \
    && apt-get update \
    && apt-get install -y powershell \
    && rm -rf /var/lib/apt/lists/*

# Instalar m贸dulo de Exchange Online (se cachea)
RUN pwsh -Command "Install-Module -Name ExchangeOnlineManagement -Force -AllowClobber"

# Crear directorio para logs (se cachea)
RUN mkdir -p /var/log/cron

# Copiar y configurar crontab (solo si cambia el archivo)
COPY infra/cron/crontab /etc/cron.d/app-cron
RUN chmod 0644 /etc/cron.d/app-cron && crontab /etc/cron.d/app-cron

# Copiar package files (se cachea si no cambian dependencias)
COPY package*.json ./

# Instalar dependencias Node (se cachea si no cambia package-lock.json)
RUN npm ci

# Copiar c贸digo y build (solo se ejecuta si cambia el c贸digo)
COPY . .
RUN npm run build

# Iniciar cron y la aplicaci贸n
CMD ["/bin/sh", "-c", "cron && node ./dist/index.js"]
